# Contract: Certificate Authority Management

**Feature**: 002-automatic-ssl-termination
**Component**: `src/proxy/mkcert.go`
**Date**: 2025-10-18

## Overview

This contract defines the API for Certificate Authority (CA) creation, loading, and lifecycle management. The CA is the root of trust for all SSL certificates generated by ddollar.

---

## Function: EnsureCA

### Purpose
Get existing CA or create new one if it doesn't exist. This is the primary entry point for CA operations.

### Signature

```go
func EnsureCA() (*CA, error)
```

### Behavior

**When CA exists** (`~/.ddollar/ca/rootCA.pem` present):
1. Load CA certificate and private key from filesystem
2. Validate CA certificate is well-formed PEM
3. Verify CA private key matches certificate public key
4. Check CA is within validity period
5. Return loaded CA instance

**When CA doesn't exist**:
1. Create `~/.ddollar/ca/` directory (mode 0755)
2. Generate RSA-2048 private key
3. Create self-signed CA certificate (365-day validity)
4. Write `rootCA-key.pem` (mode 0600)
5. Write `rootCA.pem` (mode 0644)
6. Return new CA instance

### Input
- None (uses standard `~/.ddollar/ca/` location)

### Output

**Success**:
```go
ca := &CA{
    RootCAPath:    "~/.ddollar/ca/rootCA.pem",
    RootCAKeyPath: "~/.ddollar/ca/rootCA-key.pem",
    Created:       time.Now(),
    CommonName:    "ddollar Local CA",
    ValidFrom:     time.Now(),
    ValidUntil:    time.Now().Add(365 * 24 * time.Hour),
}
return ca, nil
```

**Error Cases**:
- Filesystem permissions denied: `error: "failed to create CA directory: permission denied"`
- Disk full: `error: "failed to write CA files: no space left on device"`
- Invalid existing CA: `error: "CA certificate is corrupted or invalid"`
- Key mismatch: `error: "CA private key does not match certificate"`

### Side Effects
- Creates `~/.ddollar/ca/` directory if it doesn't exist
- Writes `rootCA.pem` and `rootCA-key.pem` files on CA generation

### Example Usage

```go
ca, err := EnsureCA()
if err != nil {
    log.Fatalf("Failed to initialize CA: %v", err)
}
fmt.Printf("CA ready: %s\n", ca.CommonName)
```

### Testing

**Unit Test** (`tests/unit/mkcert_test.go`):
```go
func TestEnsureCA_CreatesNewCA(t *testing.T) {
    // Setup: Clean test directory
    testDir := t.TempDir()
    os.Setenv("HOME", testDir)

    // Execute
    ca, err := EnsureCA()

    // Assert
    assert.NoError(t, err)
    assert.NotNil(t, ca)
    assert.Equal(t, "ddollar Local CA", ca.CommonName)
    assert.FileExists(t, ca.RootCAPath)
    assert.FileExists(t, ca.RootCAKeyPath)
}

func TestEnsureCA_LoadsExistingCA(t *testing.T) {
    // Setup: Create CA first
    ca1, _ := EnsureCA()

    // Execute: Load same CA
    ca2, err := EnsureCA()

    // Assert: Should load, not recreate
    assert.NoError(t, err)
    assert.Equal(t, ca1.Fingerprint, ca2.Fingerprint)
}
```

**Integration Test** (`tests/integration/mkcert_test.go`):
```go
func TestEnsureCA_RealFilesystem(t *testing.T) {
    // Requires actual filesystem, not temp
    ca, err := EnsureCA()
    assert.NoError(t, err)

    // Verify real files created
    info, _ := os.Stat(ca.RootCAKeyPath)
    assert.Equal(t, os.FileMode(0600), info.Mode().Perm())
}
```

---

## Function: InstallTrust

### Purpose
Install CA certificate into system trust stores. Requires elevated permissions (sudo/admin).

### Signature

```go
func InstallTrust(ca *CA) error
```

### Behavior

1. Detect operating system (macOS/Linux/Windows)
2. Detect available trust stores (system + NSS if present)
3. For each trust store:
   - Check if CA already installed (idempotent)
   - If not installed, install CA certificate
   - Verify installation succeeded
4. Return error only if all trust stores fail

### Input
- `ca`: CA instance from `EnsureCA()`

### Output

**Success**:
```go
return nil  // At least one trust store installation succeeded
```

**Partial Success** (system succeeds, NSS fails):
```go
return nil  // Still success - NSS is optional
```

**Error Cases**:
- No elevated permissions: `error: "trust installation requires sudo/administrator privileges"`
- All trust stores failed: `error: "failed to install CA: [system error], [NSS error]"`
- Unsupported platform: `error: "platform not supported: freebsd"`

### Platform-Specific Behavior

**macOS**:
```bash
security add-trusted-cert -d -r trustRoot \
    -k /Library/Keychains/System.keychain \
    ~/.ddollar/ca/rootCA.pem
```

**Linux (Debian/Ubuntu)**:
```bash
cp ~/.ddollar/ca/rootCA.pem /usr/local/share/ca-certificates/ddollar.crt
update-ca-certificates
```

**Linux (RHEL/Fedora)**:
```bash
cp ~/.ddollar/ca/rootCA.pem /etc/pki/ca-trust/source/anchors/ddollar.pem
update-ca-trust
```

**Windows**:
```powershell
certutil -addstore -f "ROOT" %USERPROFILE%\.ddollar\ca\rootCA.pem
```

**NSS (if available)**:
```bash
certutil -A -n "ddollar Local CA" -t "C,," \
    -d sql:$HOME/.pki/nssdb \
    -i ~/.ddollar/ca/rootCA.pem
```

### Side Effects
- Adds CA certificate to system trust store
- May add to NSS trust store (Firefox/Chromium snap)
- Modifies system security settings (requires user consent)

### Example Usage

```go
ca, _ := EnsureCA()

err := InstallTrust(ca)
if err != nil {
    // Provide fallback instructions
    fmt.Println("⚠️  Automatic trust failed. Manual instructions:")
    PrintManualInstructions()
    // Continue anyway - user can trust manually
}
```

### Testing

**Unit Test** (mocked):
```go
func TestInstallTrust_DetectsPlatform(t *testing.T) {
    ca := &CA{RootCAPath: "test.pem"}

    // Mock platform detection
    osType := detectOS()
    assert.Contains(t, []string{"macos", "linux", "windows"}, osType)
}
```

**Integration Test** (requires sudo):
```go
func TestInstallTrust_ActualInstallation(t *testing.T) {
    if os.Getuid() != 0 {
        t.Skip("Requires sudo")
    }

    ca, _ := EnsureCA()
    err := InstallTrust(ca)
    assert.NoError(t, err)

    // Verify trust
    err = VerifyTrust(ca)
    assert.NoError(t, err)

    // Cleanup
    UninstallTrust(ca)
}
```

---

## Function: UninstallTrust

### Purpose
Remove CA certificate from system trust stores. Used during uninstallation or cleanup.

### Signature

```go
func UninstallTrust(ca *CA) error
```

### Behavior

1. Detect operating system
2. For each trust store where CA is installed:
   - Remove CA certificate
   - Refresh trust store
3. Return error only if removal fails

### Input
- `ca`: CA instance to uninstall

### Output

**Success**:
```go
return nil  // CA removed from all trust stores
```

**Partial Success**:
```go
return nil  // Removed from system, NSS not present (OK)
```

**Error Cases**:
- No elevated permissions: `error: "trust removal requires sudo/administrator privileges"`
- CA not found in trust store: `error: "CA not installed, nothing to remove"`
- Removal failed: `error: "failed to remove CA from trust store"`

### Platform-Specific Behavior

**macOS**:
```bash
security delete-certificate -c "ddollar Local CA" \
    /Library/Keychains/System.keychain
```

**Linux (Debian/Ubuntu)**:
```bash
rm /usr/local/share/ca-certificates/ddollar.crt
update-ca-certificates --fresh
```

**Linux (RHEL/Fedora)**:
```bash
rm /etc/pki/ca-trust/source/anchors/ddollar.pem
update-ca-trust
```

**Windows**:
```powershell
certutil -delstore "ROOT" "ddollar Local CA"
```

**NSS**:
```bash
certutil -D -n "ddollar Local CA" -d sql:$HOME/.pki/nssdb
```

### Side Effects
- Removes CA from trust stores
- SSL connections using ddollar certs will fail after removal

### Example Usage

```go
ca, _ := EnsureCA()

err := UninstallTrust(ca)
if err != nil {
    fmt.Printf("Warning: Failed to remove trust: %v\n", err)
    PrintManualRemovalInstructions()
}
```

### Testing

```go
func TestUninstallTrust_RemovesCA(t *testing.T) {
    if os.Getuid() != 0 {
        t.Skip("Requires sudo")
    }

    ca, _ := EnsureCA()
    InstallTrust(ca)

    // Execute
    err := UninstallTrust(ca)
    assert.NoError(t, err)

    // Verify removed
    err = VerifyTrust(ca)
    assert.Error(t, err) // Should fail - not trusted
}
```

---

## Function: VerifyTrust

### Purpose
Check if CA is actually trusted by the system. Used for status reporting and validation.

### Signature

```go
func VerifyTrust(ca *CA) error
```

### Behavior

1. Attempt to verify CA certificate against system trust store
2. Check both system and NSS stores
3. Return error if CA is not trusted

### Input
- `ca`: CA instance to verify

### Output

**Success** (CA is trusted):
```go
return nil
```

**Error** (CA not trusted):
```go
return error: "CA is not trusted by system"
```

### Example Usage

```go
ca, _ := EnsureCA()

if err := VerifyTrust(ca); err != nil {
    fmt.Println("⚠️  CA not trusted. Run: sudo ddollar trust")
} else {
    fmt.Println("✓ CA is trusted")
}
```

### Testing

```go
func TestVerifyTrust_DetectsUntrusted(t *testing.T) {
    ca, _ := EnsureCA()
    // Don't install trust

    err := VerifyTrust(ca)
    assert.Error(t, err)
    assert.Contains(t, err.Error(), "not trusted")
}

func TestVerifyTrust_DetectsTrusted(t *testing.T) {
    if os.Getuid() != 0 {
        t.Skip("Requires sudo")
    }

    ca, _ := EnsureCA()
    InstallTrust(ca)

    err := VerifyTrust(ca)
    assert.NoError(t, err)

    // Cleanup
    UninstallTrust(ca)
}
```

---

## Error Handling Strategy

### Graceful Degradation

```go
ca, err := EnsureCA()
if err != nil {
    return fmt.Errorf("cannot start ddollar: %w", err)
}

err = InstallTrust(ca)
if err != nil {
    // Log warning but continue
    log.Printf("⚠️  Automatic trust failed: %v", err)
    log.Println("Manual trust instructions:")
    PrintManualInstructions()
    // Continue - proxy can still start
}

// Proxy startup continues...
```

### User-Facing Error Messages

**Permission Error**:
```
❌ Failed to install certificate trust

ddollar needs administrator privileges to install certificates.
Please run with sudo:

  sudo ddollar start
```

**Platform Error**:
```
❌ Automatic certificate trust not supported on this platform

Your system: freebsd
Supported: macOS, Linux, Windows

Manual trust instructions:
  1. Import certificate: ~/.ddollar/ca/rootCA.pem
  2. Mark as trusted for SSL
  3. Restart ddollar
```

---

## Contract Summary

**Functions**: 4 (EnsureCA, InstallTrust, UninstallTrust, VerifyTrust)
**Error Strategy**: Graceful degradation with clear user guidance
**Side Effects**: Filesystem (CA files) + System trust stores
**Testing**: Unit (mocked) + Integration (requires sudo)
**Platforms**: macOS, Linux (Debian/Ubuntu, RHEL/Fedora), Windows, NSS (optional)
